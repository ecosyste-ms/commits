<% @meta_title = "#{@repository.full_name} commits | #{@host}" %>
<% @meta_description = "Commits for #{@repository.full_name} on #{@host}" %>

<div class="container-sm">
  <h1>
    <%= link_to @host, host_path(@host) %> /
    <%= link_to @repository.full_name, host_repository_path(@host, @repository) %> /
    commits
  </h1>

  <% if @repository.description.present? %>
    <p><%= @repository.description %></p>
  <% end %>

  <% if @commits.any? %>
    <table class="table">
      <thead>
        <tr>
          <th>SHA</th>
          <th>Message</th>
          <th>Author</th>
          <th>Date</th>
          <th>Stats</th>
        </tr>
      </thead>
      <tbody>
        <% @commits.each do |commit| %>
          <tr>
            <td>
              <%= link_to commit.sha[0..7], commit.html_url, target: :_blank, class: 'font-monospace' %>
            </td>
            <td>
              <% if commit.merge %>
                <span class="badge bg-secondary">merge</span>
              <% end %>
              <%= truncate(commit.message.to_s.split("\n").first, length: 80) %>
              <% if commit.co_authors.any? %>
                <br>
                <small class="text-muted">
                  Co-authored-by: 
                  <% commit.co_authors.each_with_index do |co_author, index| %>
                    <%= co_author[:name] %> &lt;<%= obfusticate_email(co_author[:email]) %>&gt;<% if index < commit.co_authors.length - 1 %>, <% end %>
                  <% end %>
                </small>
              <% end %>
              <% if commit.signed_off_by.any? %>
                <br>
                <small class="text-muted">
                  Signed-off-by: 
                  <% commit.signed_off_by.each_with_index do |signer, index| %>
                    <%= signer[:name] %> &lt;<%= obfusticate_email(signer[:email]) %>&gt;<% if index < commit.signed_off_by.length - 1 %>, <% end %>
                  <% end %>
                </small>
              <% end %>
            </td>
            <td>
              <small>
                <% author_parts = commit.author.to_s.match(/^(.+?)\s*<(.+?)>$/) %>
                <% if author_parts %>
                  <%= author_parts[1] %> &lt;<%= obfusticate_email(author_parts[2]) %>&gt;
                <% else %>
                  <%= commit.author %>
                <% end %>
                <% if commit.committer && commit.committer != commit.author %>
                  <br>
                  <span class="text-muted">
                    Committed by: 
                    <% committer_parts = commit.committer.to_s.match(/^(.+?)\s*<(.+?)>$/) %>
                    <% if committer_parts %>
                      <%= committer_parts[1] %> &lt;<%= obfusticate_email(committer_parts[2]) %>&gt;
                    <% else %>
                      <%= commit.committer %>
                    <% end %>
                  </span>
                <% end %>
              </small>
            </td>
            <td>
              <small><%= time_ago_in_words(commit.timestamp) %> ago</small>
            </td>
            <td>
              <small>
                <% if commit.files_changed > 0 %>
                  <%= commit.files_changed %> files
                  <span class="text-success">+<%= commit.additions %></span>
                  <span class="text-danger">-<%= commit.deletions %></span>
                <% end %>
              </small>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
    
    <%== pagy_bootstrap_nav(@pagy) if @pagy.pages > 1 %>
  <% else %>
    <p class="text-muted">
      <i>No commits imported for this repository yet.</i>
    </p>
  <% end %>
  
  <p>
    <%= link_to "← Back to repository", host_repository_path(@host, @repository), class: "btn btn-secondary btn-sm" %>
  </p>
</div>